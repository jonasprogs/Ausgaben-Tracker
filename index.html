<!DOCTYPE html>
<html lang="de" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ausgaben-Tracker</title>

  <link rel="stylesheet" href="styles.css"/>
  <link rel="stylesheet" href="sidebar.css"/>
  <meta name="theme-color" content="#0f172a"/>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <button class="close-btn" id="closeSidebarBtn">Ã—</button>
    <button class="nav-link" data-page="ausgaben">ğŸ“„ Ausgaben-Tracker</button>
    <button class="nav-link" data-page="vermoegen">ğŸ’° VermÃ¶gen</button>
    <button class="nav-link" data-page="trades">ğŸ“ˆ Trades</button>
    <button class="nav-link" data-page="abrechnung">ğŸ§® Abrechnung</button>
  </div>

  <div class="container" id="main-content">
    <header class="header">
      <div class="title" id="page-title">
        <button class="menu-btn" id="openSidebarBtn">â˜°</button>
        <span>ğŸ§¾ Ausgaben-Tracker</span>
      </div>

      <!-- Global Actions -->
      <div style="display:flex; gap:8px; align-items:center">
        <button id="themeToggle" class="menu-btn" title="Theme umschalten">ğŸŒ“</button>
        <button id="backupBtn" class="menu-btn" title="Backup herunterladen">â¤“ Backup</button>
        <button id="importBtn" class="menu-btn" title="Backup importieren">â¤’ Import</button>
        <input id="importFile" type="file" accept="application/json" style="display:none"/>
        <span id="persistBadge" class="w-pill" style="display:none"></span>
        <!-- ğŸ”’ App-Sperre -->
        <button id="lockBtn" class="menu-btn" title="Sperre / Sicherheit">ğŸ”’ Sperre</button>
      </div>
    </header>

    <!-- Seite 1: Ausgaben -->
    <section id="page-ausgaben" style="display:block">
      <div id="app"></div>
    </section>

    <!-- Seite 2: VermÃ¶gen -->
    <section id="page-vermoegen" style="display:none">
      <div id="wealth-app" style="padding:16px;"></div>
    </section>

    <!-- Seite 3: Trades -->
    <section id="page-trades" style="display:none">
      <div id="trades-app" style="padding:16px;"></div>
    </section>

    <!-- Seite 4: Abrechnung -->
    <section id="page-abrechnung" style="display:none">
      <div id="summary-app" style="padding:16px;"></div>
    </section>
  </div>

  <!-- Libraries -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/dayjs@1/dayjs.min.js"></script>
  <script src="https://unpkg.com/dayjs@1/plugin/utc.js"></script>
  <script src="https://unpkg.com/dayjs@1/plugin/timezone.js"></script>
  <script src="https://unpkg.com/tesseract.js@4/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <!-- Tools -->
  <script src="storage-tools.js"></script>
  <!-- ğŸ”’ Security -->
  <script src="security.js"></script>

  <!-- App-Module -->
  <script src="app.js"></script>
  <script src="wealth.js"></script>
  <script src="trades.js"></script>
  <script src="abrechnung.js"></script>

  <!-- Router + Theme + Backup/Import + Lock-Button -->
  <script>
    (function(){
      const pages = ["ausgaben","vermoegen","trades","abrechnung"];
      const $ = (s)=>document.querySelector(s);

      function navigate(page){
        pages.forEach(p=>{
          const el = $("#page-"+p);
          if (el) el.style.display = (p===page) ? "block" : "none";
        });
        $("#page-title").querySelector("span").textContent =
          page==="ausgaben" ? "ğŸ§¾ Ausgaben-Tracker" :
          page==="vermoegen" ? "ğŸ’° VermÃ¶gen" :
          page==="trades"    ? "ğŸ“ˆ Trades" :
                               "ğŸ§® Abrechnung";
        closeSidebar();
        if (page!=="ausgaben") window.scrollTo({top:0,behavior:"smooth"});
      }

      function openSidebar(){ $("#sidebar").classList.add("open"); }
      function closeSidebar(){ $("#sidebar").classList.remove("open"); }
      document.addEventListener("click",(e)=>{
        const btn = e.target.closest(".nav-link"); if (!btn) return;
        const page = btn.dataset.page; if (page) navigate(page);
      });
      $("#openSidebarBtn")?.addEventListener("click", openSidebar);
      $("#closeSidebarBtn")?.addEventListener("click", closeSidebar);

      // Theme
      const THEME_KEY = "app-theme";
      const root = document.documentElement;
      const stored = localStorage.getItem(THEME_KEY);
      if (stored) root.setAttribute("data-theme", stored);
      $("#themeToggle")?.addEventListener("click", ()=>{
        const cur = root.getAttribute("data-theme") || "dark";
        const next = cur==="dark" ? "light" : "dark";
        root.setAttribute("data-theme", next);
        localStorage.setItem(THEME_KEY, next);
      });

      // Persistenz
      StorageTools.migrateOnce();
      StorageTools.requestPersistence().then(state=>{
        const badge = document.getElementById("persistBadge");
        if (!badge) return;
        badge.style.display = "inline-flex";
        badge.textContent = (state==="granted") ? "Speicher: dauerhaft" :
                            (state==="prompt")  ? "Speicher: anfragbar" :
                                                 "Speicher: nicht verfÃ¼gbar";
      });

      // Backup/Import
      const importInput = document.getElementById("importFile");
      document.getElementById("backupBtn")?.addEventListener("click", ()=>StorageTools.downloadBackup());
      document.getElementById("importBtn")?.addEventListener("click", ()=>importInput.click());
      importInput?.addEventListener("change", async (e)=>{
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        try{
          const txt = await file.text();
          const count = StorageTools.restoreFromBackup(txt);
          alert("Import erfolgreich. " + count + " Bereiche wiederhergestellt.");
          navigate("ausgaben");
        }catch(err){
          alert("Import fehlgeschlagen: " + (err?.message || err));
        }finally{
          e.target.value = "";
        }
      });

      // ğŸ”’ Lock Button
      document.getElementById("lockBtn")?.addEventListener("click", ()=>{
        if (window.AppLock) window.AppLock.openSettings();
      });

      // Start
      navigate("ausgaben");
      window.navigate = navigate;
    })();
  </script>
</body>
</html>